#!/bin/bash

msg=$1
amend=$2

if [[ $amend != "" ]]; then
  if [[ $amend != "--amend" ]]; then
    echo "uhh!! I don't know what to do with $amend"
    exit 1
  fi
fi

if [[ $msg == "" ]]; then
  echo "Please enter a commit message."
  exit 1
fi

stylecheck=0
if [[ -e "scalastyle-config.xml" ]]; then
  sbt compile test scalastyle test:scalastyle
  stylecheck=$?
fi

if [[ $stylecheck == 0 ]]; then
  uncommittedFiles=`git status | grep "Changes not staged for commit" | wc -l | tr -d '[:space:]'`
  if [[ $uncommittedFiles == "0" ]]; then
    commitGoAhead="y"
  else
    echo "There are files that have been modified but not added. Are you sure you want to commit the current state? (y/n)"
    read commitGoAhead
  fi
  if [[ $commitGoAhead == 'y' ]]; then
    git commit $amend -m "$msg"
  else
    echo "Cancelled commit"
  fi
else
  echo "Stylecheck or compile failed. Please entertain the belligerent requests of the mechanical code parsers."
fi
